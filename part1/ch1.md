# Domain Modeling Made Functional

## Domain-Driven Design 소개

- 코드만 잘 짜면 되는 것이 아님
- 좋은 설계가 좋은 결과를 줄 것임
- DDD는 Data Driven, Object Oriented와는 다름
- DDD 접근 방식이 항상 좋은 것은 아니지만 비개발자와 협업하는 엔터프라이즈 개발에는 도움이 됨

### 공유 모델의 중요성

- 문제를 풀기전에 문제를 정확히 이해하는 것이 중요함
- 개발자가 도메인을 잘 이해하는 것이 중요함
- 도메인 전문가가 비즈니스 분석가에게 도메인에 대해 설명한 후 분석가는 요구사항 명세를 만들고 아키텍트에게
  전달하고 다음 개발팀으로 전달되면 도메인에 대한 내용이 왜곡 될 가능성이 커짐
- 도메인 전문가가 개발팀에게 직접 도메인에 대한 설명을 하고 개발팀이 구현 후 도메인 전문가에게 피드백을
  주는 애자일 방식이 그나마 나음
- 하지만 애자일 방식에서 피드백이 빠르긴 하지만 도메인 내용이 왜곡될 수 있음
- 만약 소스 코드가 개발팀과 도메인 전문가와 이해관계자가 함께 볼 수 있다면 더 빠른 피드백으로 도메인 내용을
  빨리 반영할 수 있음. 이것이 DDD의 목표.
- 소프트웨어 모델과 도메인 모델을 일치시키면 다음과 같은 이점이 있다
  - 더 빨리 시장에 출시 할 수 있다
  - 문제를 정확히 해결하는 솔루션은 고객에게 더 큰 가치를 준다
  - 명확한 명세는 오해로 인한 재작업을 시간 낭비를 줄여준다
  - 코드가 모델을 반영할 때 유지 보수하기 쉽다
- 공유 모델을 만들기 위한 가이드
  - 데이터 구조 보다는 비지니스 이벤트와 워크플로우에 집중
  - 도메인을 더 작은 서브 도메인 단위로 나눈다
  - 서브 도메인으로 도메인을 모델로 만든다.
  - 프로젝트에 참여하는 사람이 공유할 수 있는 일반적인 언어(유비쿼터스 언어)로 만든다.

### 비지니스 이벤트를 통해 도메인 이해하기

- 도메인을 이해하기 위해서 비지니스 이벤트 부터 시작하는 것이 좋다.
- 비지니스는 데이터 변환 과정에 가치가 있기 때문에 이 변환 과정이 어떻게 되는지 이해하는 것이 중요하다.
- 아무 것도 하지 않는 정적인 데이터는 쓸모가 없다.
- 특정 이벤트로 데이터 변환이 시작된다. (이메일, 전화를 받거나, 정해진 시간이 되거나...)
- 뭐가 되든 이것이 중요하고 이것을 도메인 이벤트라고 부른다.
- 도메인 이벤트는 비지니스 프로세스의 시작점이 된다. 예를 들어 '새로운 주문을 받았다'라는 이벤트는 주문
  프로세스가 시작됨을 말한다.
- 도메인 이벤트는 변할 수 없기 때문에 항상 과거 시점을 작성된다.

#### 도메인을 발견하기 위해 이벤트 스토밍 사용하기

- 프로젝트가 성공하기 바라는 모든 사람들이 모여 도메인 이벤트를 나열한다.
- 긴 벽이 있는 회의실에 포스트잇으로 이벤트 스토밍을 한다
- 워크샵 동안 참여자는 포스트잇에 도메인 비지니스 이벤트를 적어 붙인다
- 이벤트는 시간 순으로 나열된다
- 누구나 질문하고 누구나 대답한다

#### 도메인 발견하기: 주문 추적 시스템

* 이 책에서는 주문 추적 시스템이라는 실제 비즈니스 문제를 다룰 것이다
* 이 문제를 가지고 설계하는 것과 도메인 모델링 구현을 해볼 것이다

- Widget Inc 라는 회사는 자동화된 주문 추적을 온라인 시스템으로 만들기로 하였다.

- 맥스라는 매니저가 상황 설명을 한다

  ```
  저희 회사는 다른 회사를 위해 위젯이나 기즈모 같은 부품을 만드는 작은 회사입니다. 회사가 빠르게 성장했고 현재 프로세스를 유지하기 어렵게 되었습니다. 지금은 모든 것을 수기로 하고 있는데 전산화를 해서 직원들이 더 큰 주문을 처리할 수 있었으면 합니다. 특히 고객들이 웹사이트를 통해 주문하기나 주문 상태 확인 같이 고객이 할 수 있는 것들은 고객이 직접 할 수 있었으면 좋겠습니다.
  ```

- 그럼 어디서 시작해볼까요?

* 첫번째 가이드라인인 "비즈니스 이벤트"에 집중 하기를 생각하면서 이벤트 스토밍 세션을 해보자.

  ```
  당신: 비즈니스 이벤트 붙이는 것을 시작해보실 분!
  올리: 주문 추적 부서에 올리입니다. 들어오는 주문과 견적을 처리하는 일이 대부분 입니다.
  당신: 이 일은 어떤 것에 의해 생기나요?
  올리: 고객이 이메일로 양식을 우리에게 보낼 때 생기는 일입니다.
  당신: 그러면 이벤트는 "Order form received"나 "Quote form received" 같은 것이 되면 될까요?
  올리: 네! 제가 써서 벽에 붙일께요.
  샘: 저는 배송 부서에 샘입니다. 우리는 그 주문이 승인되면 처리합니다.
  당신: 승인되었다는 것은 어떻게 아나요?
  샘: 주문이 배송 추적 부서에서 넘어올 때 압니다.
  당신: 이 이벤트는 뭐라고 부를까요?
  샘: "Order available"이 어떨까요?
  올리: 우리는 배송 준비가 완료된 주문을 "Placed order"라고 부르는데요. 다들 이 용어를 쓰는 것에 동의하시는지요?
  샘: 그러면 "Order placed"라는 것이 우리가 다루고 있는 이벤트가 될 수 있겠네요.
  ```

* 시간이 흐르고 아래와 같은 이벤트가 나왔다

  * Order form received
  * Order placed
  * Order shipped
  * Order change requested
  * Order cancellation requested
  * Return requested
  * Quote form received
  * Quote provided
  * New customer request received
  * New customer registered

- 어떤 비즈니스 이벤트는 앞에 "Place order"이나 "Ship order" 같은 포스트잇이 붙어 있다.

- 이벤트 스토밍 세션 전체를 자세히 다루진 않겠지만 몇 가지는 살펴보자

  - 비즈니스에 대한 공유 모델

    - 이벤트 스토밍의 중요한 이점은 이벤트를 도출하는 것 뿐만 아니라 참여자 모두가 벽에 있는 같은 것을 보기 때문에 비즈니스에 대한 이해를 공유하고 발전 시킨다는 점에 있다
    - 이벤트 스토밍도 DDD 처럼 당신과 나에 대한 생각 대신 공유 모델과 커뮤니케이션을 강조한다
    - 참석자들은 생소한 도메인에 대한 지식을 배우기도 하지만 다른 팀에 대한 가정이 잘 못되었다는 것을 알거나 비즈니스 개선에 도움이 되는 인사이트도 발전시켜 나갈 수 있다

  - 모든 용어의 인지

    - 가끔 자신에게 관련 있는 비즈니스 한 측면에만 집중하고 자신이 만드는 데이터를 사용하는 다른 팀이 관련되어 있다는 사실을 잊을 때 도 있다

    - 모든 이해 관계자가 한 방에 있다면 보고 있는 사람 중 누구든지 이야기할 수 있다.

      ```
      빌링 부서에 블래이크입니다. 우리가 있다는 것을 잊지 마세요. 우리도 주문 절차에 대해 완벽하게 알아야합니다. 그래야 고객이 지불하고 회사가 돈을 벌 수 있습니다. 그래서 우리도 마찬가지로 "Order placed" 이벤트가 필요합니다.
      ```

  - 요구 사항의 간극을 발견하기

    - 이벤트가 시간 순으로 벽에 나열되 있을 때 가끔 빠진 요구 사항이 명확해진다.

      ```
      맥스: 올리, 주문 준비가 끝났을 때 고객에게 알려주나요? 벽에는 표시되있지 않아서요.
      올리: 아! 맞아요! 깜빡했네요. 주문이 들어오면 우리가 잘 받았고 배송될 것이라는 것을 고객에게 이메일로 보냅니다. 이건 또 다른 이벤트인데 "Order acknowledgment sent to customer"가 될 것 같아요.
      ```

    - 질문에 대한 명확한 답이 없다면 나중에 다시 이야기해보기 위해 포스트잇으로 붙여논다

    - 만약 특정한 프로세스에 대한 논쟁이나 일치되지 않은 의견이 있다면 문제라고 생각하지 말고 기회라고 생각하는 것이 좋다

    - 이런 부분에서 많은 것을 배울 수 있다. 

    - 프로젝트가 시작할 때 요구 사항이 모호한 것은 당연한 것이라서 질문이나 논쟁을 시각적으로 문서화하면 더 많은 일을 해야하고 프로젝트를 시작하지 못하게 만든다.

  - 용어 간 연결

    - 타임 라인에 있는 이벤트는 그룹화 할 수 있다. 어떤 팀이 결과물이 다른 팀의 입력 값이 될 수 있다는 것이 명확해진다.
    - 예를 들어 배송 추적 팀에서 주문이 완료되었을 때 새로운 주문이 들어왔다는 신호가 필요하다.  이 "Order placed" 이벤트는 배송 팀과 결제 팀에 입력이 된다.
    - 기술적으로 구체적으로 어떻게 연결되는지는 나타내지 않는다
    - 메시지 큐가 좋은 지 데이터베이스가 좋은지는 중요하지 않고 도메인에 집중하는 것이 필요하다

  - 리포팅 요구 사항에 대한 인지

    - 도메인을 이해할 때 프로세스와 트랜젝션에 집중하기는 쉽다
    - 어떤 비즈니스는 과거에 어떤 일이 있었는지 이해하는 것이 중요하다 - 리포팅은 항상 도메인의 일부다
    - 리포팅이나 다른 읽기 전용 모델(UI에서 뷰 모델)도 이벤트 스토밍에 포함시키도록 한다

- 워크플로우, 시나리오, 유즈 케이스, 프로세스 용어에 대해서

  * 많은 곳에서 위 용어를 혼용해서 쓰지만 여기서는 조금 더 명확하게 정의하고 쓰겠다
  * 시나리오는 주문 입력과 같이 고객이 달성하고자 하는 목표를 기술 한다. 애자일에 사용자 스토리와 비슷하다.
  * 유즈케이스는 시나리오에 구체적인 버전이다. 일반적인 용어로 고객이 목표를 달성하기 위해 사용자 액션이나 다른 단계들을 기술 한다.
  * 시나리오나 유즈케이스 모두 사용자 관점에서 어떻게 상호작용 할 것인지 중점을 두는 사용자 중심 컨셉이다.
  * 비즈니스 프로세스는 개인 고객이 아닌 비즈니스 관점에서 달성하고자 하는 것을 기술 한다. 시나리오와 비슷하지만 사용자 중심보다 비즈니스 중심 적이다.
  * 워크플로우는 비즈니스 프로세스의 한 부분을 기술 한다. 비즈니스 목표를 달성하기 위한 정확한 단계를 나타내는 목록이다. 
    * 워크플로우는 한 사람이나 한팀이 할 수 있는 일로 제한되고 비즈니스 프로세스가 여러 팀에 걸쳐서 분산될 때(주문 프로세스 처럼)는 전체 비즈니스 프로세스를 작은 워크플로우로 나눌 수 있다.

#### 커맨드을 문서화

* 벽에 이벤트가 몇 개 생겼을 때 무엇이 이벤트를 만드는지 질문해 볼 수 있다.
* 누군가 또는 무언가가 이벤트가 발생되길 원했다. 예를 들어 고객은 우리가 주문서를 받길 원했거나 상사가 당신이 뭔가 하길 원했다.
* 이런 것을 DDD 용어로 커맨드라고 부른다. (객체지향 패턴에 커맨드 패턴과는 다른 것이다)
* 커맨드는 항상 명령형으로 표현한다. "Do this for me"
* 물론 모든 커맨드가 성공하진 않는다 - 메일에 있는 주문서는 잃어버릴 수도 있다. 또 상사를 돕는 일 때문에 뭔가 더 중요한 일로 바쁠 수도 있다. 
* 하지만 커맨드가 성공하면 워크플로우가 동작하고 해당하는 도메인 이벤트가 생긴다. 예를 들면:
  * 커맨드가 "Make X happen" 였고 워크플로우가 X가 되게 했다면 도메인 이벤트는 "X happend"일 것이다.
  * 커맨드가 "Send an order form to Widgets Inc,"였고 워크플로우가 주문을 보냈다면 해당하는 도메인 이벤트는 "Order form sent"가 될것이다.
  * 커맨드: "Place an order"; 도메인 이벤트: "Order placed"
  * 커맨드: "Send a shipment to customer ABC";  도메인 이벤트: "Shipment sent"
* 사실 비즈니스 프로세스는 이런식으로 모델링 할 것이다. 
* 이벤트 어떤 비즈니스 워크플로우를 시작시키는 커맨드를 실행시킬 수 있다.
* 워크플로우의 결과는 몇 개의 이벤트다. 그리고 이벤트들은 여러 커맨드를 실행시킬 수 있다.
* 이런 식으로 입력과 출력을 가진 비즈니스 프로세스(파이프라인)로 생각하는 것은 함수형 프로그래밍과 잘 맞는다. 앞으로 살펴볼 것이다.
* 이 접근 방법으로 배송 추적 프로세를 보면 다음과 같다:
  * [Event] Order form received -> triggers -> [Command] Place Order -> Input: 주문에 필요한 데이터 -> [Workflow] Place Order -> Output: 이벤트 목록 [Event1] Order placed (for shipping), [Event 2] Order placed (for biling)
* 지금은 커맨드가 성공한다고 가정했지만 실패할 수도 있다. 커맨드가 실패하는 경우는 10장에서 다룬다.
* 모든 이벤트가 커맨드랑 연결될 필요는 없다. 어떤 이벤트는 스케쥴러나 모니터링 시스템에 의해 만들어 지기도한다. (계정 시스템에 MonthEndClose 나 재고 시스템에 OutOfStock)

### 도메인을 서브 도메인으로 나누기

### 경계(Bounded Context)로 문제 해결하기

- 

### 유비쿼터스 언어 만들기

### 요약
